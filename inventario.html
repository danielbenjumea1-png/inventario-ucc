// Variables globales para el inventario
let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
let codigoAFila = {};

// Inicializar mapeo de códigos
inventario.forEach((item, index) => {
    codigoAFila[item.codigo] = index;
});

// Inicializar QuaggaJS para escaneo de códigos de barras
Quagga.init({
    inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#interactive'),
        constraints: {
            width: 640,
            height: 480,
            facingMode: "environment" // Cámara trasera en móvil
        }
    },
    locator: {
        patchSize: "medium",
        halfSample: true
    },
    numOfWorkers: 2,
    decoder: {
        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
    },
    locate: true
}, function(err) {
    if (err) {
        console.log(err);
        return;
    }
    Quagga.start();
});

// Evento cuando se detecta un código
Quagga.onDetected(function(result) {
    let code = result.codeResult.code;
    code = code.toUpperCase().replace(/[^A-Z0-9]/g, ''); // Limpiar y mayúsculas

    // Filtrar códigos válidos (empiezan con B y >=7 caracteres)
    if (!code.startsWith('B') || code.length < 7) return;

    procesarCodigo(code);
});

// Función para procesar un código (automático o manual)
function procesarCodigo(codigo) {
    if (codigoAFila[codigo] !== undefined) {
        // Código encontrado: marcar en verde
        inventario[codigoAFila[codigo]].estado = 'encontrado';
        document.getElementById('result').innerHTML = `<p style="color: green;">✔ Código ${codigo} encontrado y marcado en verde.</p>`;
    } else {
        // Código nuevo: agregar en morado
        inventario.push({ codigo: codigo, estado: 'nuevo' });
        codigoAFila[codigo] = inventario.length - 1;
        document.getElementById('result').innerHTML = `<p style="color: purple;">➕ Código nuevo agregado: ${codigo}</p>`;
    }
    guardarInventario();
    actualizarTabla();
}

// Función para procesar código manual
function procesarManual() {
    let codigo = document.getElementById('codigoManual').value.trim().toUpperCase();
    if (codigo) {
        procesarCodigo(codigo);
        document.getElementById('codigoManual').value = '';
    } else {
        alert('Por favor, ingresa un código.');
    }
}

// Guardar inventario en localStorage (con backup)
function guardarInventario() {
    localStorage.setItem('inventario', JSON.stringify(inventario));
    localStorage.setItem('inventario_backup_' + Date.now(), JSON.stringify(inventario));
}

// Actualizar la tabla HTML con el inventario
function actualizarTabla() {
    let tbody = document.querySelector('#inventarioTable tbody');
    tbody.innerHTML = '';
    inventario.forEach(item => {
        let row = `<tr class="${item.estado === 'encontrado' ? 'verde' : 'morado'}"><td>${item.codigo}</td><td>${item.estado}</td></tr>`;
        tbody.innerHTML += row;
    });
}

// Descargar inventario como Excel
function descargarExcel() {
    let ws = XLSX.utils.json_to_sheet(inventario);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    XLSX.writeFile(wb, "inventario_actualizado.xlsx");
}

// Subir a SharePoint (reemplaza la URL)
function subirSharePoint() {
    let sharePointUrl = 'TU_HIPERVINCULO_DE_SHAREPOINT_AQUI'; // Pon tu URL aquí
    let data = JSON.stringify(inventario);

    fetch(sharePointUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: data
    })
    .then(response => {
        if (response.ok) {
            alert('Inventario subido exitosamente a SharePoint.');
        } else {
            alert('Error al subir a SharePoint.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión.');
    });
}

// Inicializar tabla al cargar la página
actualizarTabla();
