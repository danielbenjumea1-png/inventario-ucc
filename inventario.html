<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Biblioteca UCC - Sede Medell√≠n</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #interactive { width: 100%; max-width: 400px; }
        #result { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .verde { background-color: #00FF00; font-weight: bold; }
        .morado { background-color: #800080; color: white; font-weight: bold; }
        button { margin: 10px 0; padding: 10px; }
    </style>
</head>
<body>
    <h1>üìö Inventario Biblioteca UCC - Sede Medell√≠n</h1>
    <p>La aplicaci√≥n detecta c√≥digos autom√°ticamente y actualiza el inventario sin necesidad de presionar botones.</p>

    <h2>Escanea el c√≥digo</h2>
    <div id="interactive" class="viewport"></div>
    <div id="result"></div>

    <h2>Ingresar c√≥digo manualmente</h2>
    <input type="text" id="codigoManual" placeholder="Escribe el c√≥digo">
    <button onclick="procesarManual()">Procesar C√≥digo Manual</button>

    <h2>Inventario actualizado</h2>
    <table id="inventarioTable">
        <thead>
            <tr><th>C√≥digo</th><th>Estado</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <button onclick="descargarExcel()">Descargar inventario actualizado</button>
    <button onclick="subirSharePoint()">Subir a SharePoint</button>

    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
        let codigoAFila = {};

        // Inicializar mapeo
        inventario.forEach((item, index) => {
            codigoAFila[item.codigo] = index;
        });

        // Inicializar QuaggaJS
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment" // Usar c√°mara trasera en m√≥vil
                }
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: 2,
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"] // Tipos comunes de c√≥digos de barras
            },
            locate: true
        }, function(err) {
            if (err) {
                console.log(err);
                return;
            }
            Quagga.start();
        });

        // Manejar detecci√≥n
        Quagga.onDetected(function(result) {
            let code = result.codeResult.code;
            code = code.toUpperCase().replace(/[^A-Z0-9]/g, ''); // Limpiar y convertir a may√∫sculas

            // Filtrar c√≥digos que empiecen con B y tengan longitud adecuada
            if (!code.startsWith('B') || code.length < 7) return;

            procesarCodigo(code);
        });

        function procesarCodigo(codigo) {
            if (codigoAFila[codigo] !== undefined) {
                // Marcar como encontrado (verde)
                inventario[codigoAFila[codigo]].estado = 'encontrado';
                document.getElementById('result').innerHTML = `<p style="color: green;">‚úî C√≥digo ${codigo} encontrado y marcado en verde.</p>`;
            } else {
                // Agregar nuevo (morado)
                inventario.push({ codigo: codigo, estado: 'nuevo' });
                codigoAFila[codigo] = inventario.length - 1;
                document.getElementById('result').innerHTML = `<p style="color: purple;">‚ûï C√≥digo nuevo agregado: ${codigo}</p>`;
            }
            guardarInventario();
            actualizarTabla();
        }

        function procesarManual() {
            let codigo = document.getElementById('codigoManual').value.trim().toUpperCase();
            if (codigo) {
                procesarCodigo(codigo);
                document.getElementById('codigoManual').value = '';
            } else {
                alert('Por favor, ingresa un c√≥digo.');
            }
        }

        function guardarInventario() {
            localStorage.setItem('inventario', JSON.stringify(inventario));
            // Crear "backup" guardando una copia en localStorage con timestamp
            localStorage.setItem('inventario_backup_' + Date.now(), JSON.stringify(inventario));
        }

        function actualizarTabla() {
            let tbody = document.querySelector('#inventarioTable tbody');
            tbody.innerHTML = '';
            inventario.forEach(item => {
                let row = `<tr class="${item.estado === 'encontrado' ? 'verde' : 'morado'}"><td>${item.codigo}</td><td>${item.estado}</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function descargarExcel() {
            let ws = XLSX.utils.json_to_sheet(inventario);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "inventario_actualizado.xlsx");
        }

        function subirSharePoint() {
            // Placeholder: Reemplaza con tu URL de SharePoint
            let sharePointUrl = 'TU_HIPERVINCULO_DE_SHAREPOINT_AQUI'; // El usuario pone esto
            let data = JSON.stringify(inventario);

            fetch(sharePointUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: data
            })
            .then(response => {
                if (response.ok) {
                    alert('Inventario subido exitosamente a SharePoint.');
                } else {
                    alert('Error al subir a SharePoint.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexi√≥n.');
            });
        }

        // Inicializar tabla al cargar
        actualizarTabla();
    </script>
</body>
</html>
